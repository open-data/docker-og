upstream backend_host_drupal {

    server 172.0.0.6:4430;

}

upstream backend_host_ckanapi {

    server 172.0.0.8:5002;

}

upstream backend_host_ckan {

    server 172.0.0.7:5001;

}

upstream backend_host_solr {

    server 172.0.0.10:8983;

}

upstream backend_host_django {

    server 172.0.0.12:8000;

}

#TODO: solve reusing 443 port for multiple server blocks....

#
# Drupal/CKAN Portal Front
# open.local
#
server {

    server_name open.local;

    listen 443 default_server ssl http2 reuseport;

    include conf/ssl_settings.conf;
    include conf/default_settings.conf;

    set $upstreamHost "backend_host_drupal";
    set $upstremProtocol "https://";

    if ($request_uri ~ (^/data/)) {

        set $upstreamHost "backend_host_ckanapi";
        set $upstremProtocol "http://";

    }

    location / {

        include conf/proxy_settings.conf;

    }

    location /data/ {

        rewrite /data/(.*) /$1 last;

        include conf/proxy_settings.conf;

    }

}
# END
# Drupal/CKAN Portal Front
# END

#
# Solr
# solr.open.local
#
server {

    server_name solr.open.local;

    listen 443 ssl http2 reuseport;

    include conf/ssl_settings.conf;
    include conf/default_settings.conf;

    set $upstreamHost "backend_host_solr";
    set $upstremProtocol "https://";

    location / {

        include conf/proxy_settings.conf;

    }

}
# END
# Solr
# END

#
# CKAN Portal Back
# portal.open.local
#
server {

    server_name portal.open.local;

    listen 443 ssl http2 reuseport;

    include conf/ssl_settings.conf;
    include conf/default_settings.conf;

    set $upstreamHost "backend_host_ckanapi";
    set $upstremProtocol "http://";

    location / {

        include conf/proxy_settings.conf;

    }

}
# END
# CKAN Portal Back
# END

#
# CKAN Registry
# registry.open.local
#
server {

    server_name registry.open.local;

    listen 443 ssl http2 reuseport;

    include conf/ssl_settings.conf;
    include conf/default_settings.conf;

    set $upstreamHost "backend_host_ckan";
    set $upstremProtocol "http://";

    location / {

        include conf/proxy_settings.conf;

    }

}
# END
# CKAN Registry
# END

#
# Django
# search.open.local
#
server {

    server_name search.open.local;

    listen 443 ssl http2 reuseport;

    include conf/ssl_settings.conf;
    include conf/default_settings.conf;

    set $upstreamHost "backend_host_django";
    set $upstremProtocol "http://";

    location / {

        include conf/proxy_settings.conf;

    }

    location /static/ {

        alias /var/ogproxy/django/src/ogc-search/ogc_search/static/;
        autoindex off;

    }

}
# END
# Django
# END

#
# http::80 redirect
#
server{

    server_name ~^(?<subdomain>.+)\.open\.local open.local;

    listen 80 default_server reuseport;

    return https://$host$request_uri;

}
# END
# http::80 redirect
# END